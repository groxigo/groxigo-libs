# PR Review - Claude Code reviews every pull request
#
# WHAT IT DOES:
# =============
# 1. Triggered when a PR is opened or updated
# 2. Claude Code reviews the changes for:
#    - Code quality and best practices
#    - Potential bugs or regressions
#    - Token/design system consistency
#    - Security implications
# 3. Posts inline comments and a summary
# 4. For "Version Packages" PRs: auto-merges after successful review
#
# REQUIRED SECRETS:
# =================
# - ANTHROPIC_API_KEY: API key for Claude (Free Tier OK for version PRs)
#
# REQUIRED SETTINGS:
# ==================
# Settings → Actions → General → "Allow GitHub Actions to create and approve pull requests"

name: PR Review

on:
  pull_request:
    types: [opened, ready_for_review, reopened]

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR concisely. Keep your analysis brief to stay within token limits.

            For "Version Packages" PRs (from changesets), only check:
            - Version bumps are correct (patch/minor/major)
            - Dependent packages bumped
            - Post a short approval comment via `gh pr comment`

            For code PRs, check:
            1. Breaking changes (renamed/removed exports)
            2. Hardcoded values that should use design tokens
            3. Type safety issues
            4. Bugs or security issues

            Only flag real problems. Skip style nits.
            Use `gh pr comment` for summary feedback.
            Use inline comments only for critical issues.

          claude_args: |
            --model claude-haiku-4-5-20251001
            --max-turns 3
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

  auto-merge-versions:
    name: Auto-merge Version PRs
    runs-on: ubuntu-latest
    needs: review
    if: startsWith(github.event.pull_request.title, 'chore: version packages')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Approve and merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr review "$PR_NUMBER" --approve --repo "$GITHUB_REPOSITORY"
          gh pr merge "$PR_NUMBER" --squash --repo "$GITHUB_REPOSITORY" --auto
