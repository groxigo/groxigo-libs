# PR Review - Claude Code reviews every pull request
#
# WHAT IT DOES:
# =============
# 1. Triggered when a PR is opened or updated
# 2. Claude Code reviews the changes for:
#    - Code quality and best practices
#    - Potential bugs or regressions
#    - Token/design system consistency
#    - Security implications
# 3. Posts inline comments and a summary
# 4. For "Version Packages" PRs: auto-merges after successful review
#
# REQUIRED SECRETS:
# =================
# - ANTHROPIC_API_KEY: API key for Claude
#
# REQUIRED SETTINGS:
# ==================
# Settings → Actions → General → "Allow GitHub Actions to create and approve pull requests"

name: PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            You are reviewing a PR in the @groxigo/libs monorepo — a design system
            and component library for iOS, Android, and Web.

            Review this pull request with a focus on:

            1. **Token consistency** — Do token values match the three-tier architecture
               (Primitives → Semantic → Components)? Any hardcoded values that should
               use tokens?

            2. **Cross-platform parity** — Do changes to ui-elements have matching
               changes in ui-elements-web (and vice versa)?

            3. **Contract compliance** — Do component props match their contracts
               in @groxigo/contracts?

            4. **Type safety** — Are TypeScript types correct? Any `any` casts
               that should be typed?

            5. **Breaking changes** — Are there renamed/removed exports that would
               break consumers (groxigo-web, groxigo-mobile, groxigo-admin)?

            6. **Code quality** — Bugs, performance issues, accessibility gaps.

            If this is a "Version Packages" PR from changesets, focus only on:
            - Correct version bumps (patch/minor/major appropriate for changes)
            - Dependent packages bumped correctly
            - CHANGELOG entries accurate

            Use `gh pr comment` for top-level feedback.
            Use `mcp__github_inline_comment__create_inline_comment` for specific code issues.
            Only post GitHub comments — don't submit review text as messages.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

  auto-merge-versions:
    name: Auto-merge Version PRs
    runs-on: ubuntu-latest
    needs: review
    if: startsWith(github.event.pull_request.title, 'chore: version packages')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Approve and merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr review "$PR_NUMBER" --approve --repo "$GITHUB_REPOSITORY"
          gh pr merge "$PR_NUMBER" --squash --repo "$GITHUB_REPOSITORY" --auto
